# è®¿å­˜é˜¶æ®µ (Memory Access Stage) è¯¦ç»†æ–‡æ¡£

## ğŸ“Œ æ¦‚è¿°

è®¿å­˜é˜¶æ®µï¼ˆMemory Access Stageï¼Œç®€ç§° M é˜¶æ®µï¼‰æ˜¯ Minor-CPU æµæ°´çº¿çš„ç¬¬å››ä¸ªé˜¶æ®µï¼Œä¸“é—¨è´Ÿè´£å¤„ç†ä¸æ•°æ®å­˜å‚¨å™¨ï¼ˆD-Cacheï¼‰çš„äº¤äº’ã€‚è¯¥é˜¶æ®µä¸»è¦å®Œæˆä»¥ä¸‹ä»»åŠ¡ï¼š

1. **è¯»å–å†…å­˜æ•°æ®** - å¤„ç† `lw`ã€`lbu` ç­‰ load æŒ‡ä»¤
2. **æ•°æ®æ‰©å±•** - æ ¹æ®æŒ‡ä»¤ç±»å‹è¿›è¡Œç¬¦å·æ‰©å±•æˆ–é›¶æ‰©å±•
3. **è®¾ç½®æ—è·¯** - ä¸ºåç»­æŒ‡ä»¤æä¾›æ—è·¯æ•°æ®
4. **ä¼ é€’ç»“æœ** - å°†æ•°æ®ä¼ é€’ç»™å†™å›é˜¶æ®µ

---

## ğŸ“‚ æºæ–‡ä»¶ä½ç½®

è®¿å­˜é˜¶æ®µçš„ä»£ç ä½äº `memory_access.py` æ–‡ä»¶ä¸­ã€‚

---

## ğŸ—ï¸ æ¨¡å—å®šä¹‰

```python
class MemoryAccess(Module):

    def __init__(self):
        super().__init__(
            ports={
                'rd': Port(Bits(5)),           # ç›®æ ‡å¯„å­˜å™¨
                'mem_ext': Port(Bits(2)),      # æ‰©å±•æ¨¡å¼
                'result': Port(Bits(32)),      # æ‰§è¡Œç»“æœ/é“¾æ¥åœ°å€
                'is_mem_read': Port(Bits(1))   # æ˜¯å¦æ˜¯å†…å­˜è¯»æ“ä½œ
            },
            no_arbiter=True)  # ä¸ä½¿ç”¨ä»²è£å™¨ï¼ˆé¡ºåºæ‰§è¡Œï¼‰
        self.name = 'm'
```

### è¾“å…¥ç«¯å£è¯¦è§£

| ç«¯å£å        | ä½å®½    | æ¥æº     | è¯´æ˜                                 |
| ------------- | ------- | -------- | ------------------------------------ |
| `rd`          | 5 bits  | æ‰§è¡Œé˜¶æ®µ | ç›®æ ‡å¯„å­˜å™¨ç¼–å· (x0-x31)              |
| `mem_ext`     | 2 bits  | æ‰§è¡Œé˜¶æ®µ | æ§åˆ¶æ•°æ®æ‰©å±•æ–¹å¼                     |
| `result`      | 32 bits | æ‰§è¡Œé˜¶æ®µ | ALU è®¡ç®—ç»“æœæˆ– PC+4ï¼ˆç”¨äº jal/jalrï¼‰ |
| `is_mem_read` | 1 bit   | æ‰§è¡Œé˜¶æ®µ | 1=è¯»å†…å­˜ï¼Œ0=ä¸è¯»å†…å­˜                 |

### `mem_ext` ç¼–ç è¯´æ˜

```
mem_ext[1:0]:
  00 - å­— (word) è®¿é—®ï¼Œæ— æ‰©å±•
  01 - å­—èŠ‚ (byte) è®¿é—®ï¼Œé›¶æ‰©å±• (lbu)
  10 - (æœªä½¿ç”¨)
  11 - å­—èŠ‚ (byte) è®¿é—®ï¼Œç¬¦å·æ‰©å±• (lb)

å…·ä½“ç¼–ç :
  mem_ext[0:0] = 1 è¡¨ç¤ºå­—èŠ‚è®¿é—®
  mem_ext[1:1] = 1 è¡¨ç¤ºé›¶æ‰©å±•ï¼ˆæ— ç¬¦å·ï¼‰
```

### å¤–éƒ¨ä¾èµ–èµ„æº

| èµ„æº              | ç±»å‹                  | ç”¨é€”                   |
| ----------------- | --------------------- | ---------------------- |
| `writeback`       | Module                | å†™å›æ¨¡å—ï¼Œç”¨äºå¼‚æ­¥è°ƒç”¨ |
| `mem_bypass_reg`  | RegArray(Bits(5), 1)  | è®¿å­˜æ—è·¯å¯„å­˜å™¨å·       |
| `mem_bypass_data` | RegArray(Bits(32), 1) | è®¿å­˜æ—è·¯æ•°æ®           |
| `wb_bypass_reg`   | RegArray(Bits(5), 1)  | å†™å›æ—è·¯å¯„å­˜å™¨å·       |
| `wb_bypass_data`  | RegArray(Bits(32), 1) | å†™å›æ—è·¯æ•°æ®           |
| `rdata`           | RegArray              | D-Cache è¯»å–ç»“æœ       |

---

## ğŸ”„ æ‰§è¡Œæµç¨‹è¯¦è§£

### æ•´ä½“ä»£ç ç»“æ„

```python
@module.combinational
def build(
    self,
    writeback: Module,           # å†™å›æ¨¡å—
    mem_bypass_reg: Array,       # è®¿å­˜æ—è·¯å¯„å­˜å™¨
    mem_bypass_data: Array,      # è®¿å­˜æ—è·¯æ•°æ®
    wb_bypass_data: Array,       # å†™å›æ—è·¯æ•°æ®
    wb_bypass_reg: Array,        # å†™å›æ—è·¯å¯„å­˜å™¨
    rdata: RegArray              # D-Cache æ•°æ®è¾“å‡º
):
    self.timing = 'systolic'     # æ—¶åºæ¨¡å¼ï¼šæ”¶ç¼©é˜µåˆ—é£æ ¼
```

---

### ç¬¬ä¸€æ­¥ï¼šè·å–è¾“å…¥æ•°æ®

```python
# åˆå§‹åŒ–ä¸­é—´å˜é‡
data_cut = Bits(32)(0)

# ä»ç«¯å£å¼¹å‡ºæ•°æ®
mem_ext = self.mem_ext.pop()        # æ‰©å±•æ¨¡å¼
result = self.result.pop()          # æ‰§è¡Œç»“æœ
rd = self.rd.pop()                  # ç›®æ ‡å¯„å­˜å™¨
is_mem_read = self.is_mem_read.pop() # æ˜¯å¦è¯»å†…å­˜

# ä» D-Cache è·å–è¯»å–çš„æ•°æ®
data = rdata[0].bitcast(Bits(32))
```

**`pop()` vs `peek()` çš„åŒºåˆ«**ï¼š

- `pop()`: æ¶ˆè€—ç«¯å£ä¸­çš„æ•°æ®ï¼Œä» FIFO ä¸­ç§»é™¤
- `peek()`: æŸ¥çœ‹æ•°æ®ä½†ä¸æ¶ˆè€—ï¼Œæ•°æ®ä¿ç•™åœ¨ FIFO ä¸­

åœ¨è®¿å­˜é˜¶æ®µï¼Œæˆ‘ä»¬éœ€è¦æ¶ˆè€—ä»æ‰§è¡Œé˜¶æ®µä¼ æ¥çš„æ•°æ®ï¼Œæ‰€ä»¥ä½¿ç”¨ `pop()`ã€‚

---

### ç¬¬äºŒæ­¥ï¼šè®¾ç½®è®¿å­˜æ—è·¯

```python
with Condition(is_mem_read):
    log("mem.rdata        | 0x{:x}", data)
    mem_bypass_reg[0] = rd

    with Condition(rd != Bits(5)(0)):
        log("mem.bypass       | x{:02} = 0x{:x}", rd, data)
        mem_bypass_data[0] = data

with Condition(~is_mem_read):
    mem_bypass_reg[0] = Bits(5)(0)  # éè¯»æ“ä½œä¸è®¾ç½®æ—è·¯
```

**è®¿å­˜æ—è·¯çš„é‡è¦æ€§**ï¼š

è€ƒè™‘ä»¥ä¸‹ä»£ç åºåˆ—ï¼š

```asm
lw   x1, 0(x2)    # å‘¨æœŸ 1: E, å‘¨æœŸ 2: M, å‘¨æœŸ 3: W
addi x3, x1, 1    # å‘¨æœŸ 2: E - éœ€è¦ x1 çš„å€¼ï¼
```

æ²¡æœ‰è®¿å­˜æ—è·¯æ—¶ï¼š

- `addi` åœ¨æ‰§è¡Œé˜¶æ®µéœ€è¦ `x1` çš„å€¼
- ä½† `lw` çš„ç»“æœè¿˜åœ¨è®¿å­˜é˜¶æ®µï¼Œå°šæœªå†™å›
- æµæ°´çº¿å¿…é¡»æš‚åœ 1-2 ä¸ªå‘¨æœŸ

æœ‰äº†è®¿å­˜æ—è·¯ï¼š

- `lw` åœ¨è®¿å­˜é˜¶æ®µå°†æ•°æ®å†™å…¥ `mem_bypass_data`
- `addi` åœ¨æ‰§è¡Œé˜¶æ®µå¯ä»¥ä»æ—è·¯è·å–æ•°æ®
- æ— éœ€æš‚åœï¼

**æ—è·¯æ•°æ®æµå›¾**ï¼š

```
å‘¨æœŸ N:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Fetch   â”‚â”€â”€â”€â”€â–¶â”‚ Decode  â”‚â”€â”€â”€â”€â–¶â”‚ Execute â”‚â”€â”€â”€â”€â–¶â”‚ MemAccessâ”‚
â”‚ (lw)    â”‚     â”‚ (lw)    â”‚     â”‚ (lw)    â”‚     â”‚ (lw)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                                                      â”‚
                                                      â”‚ mem_bypass
                                                      â–¼
å‘¨æœŸ N+1:       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Decode  â”‚â”€â”€â”€â”€â–¶â”‚ Execute â”‚â—„â”€â”€â”€â”€â”‚   ...   â”‚
                â”‚ (addi)  â”‚     â”‚ (addi)  â”‚     â”‚         â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â”‚ ä»æ—è·¯è·å– x1
                                     â–¼
                                æ‰§è¡Œæ— éœ€æš‚åœ
```

---

### ç¬¬ä¸‰æ­¥ï¼šæ•°æ®æ‰©å±•å¤„ç†

RISC-V æ”¯æŒä¸åŒå®½åº¦çš„å†…å­˜è®¿é—®ï¼Œéœ€è¦è¿›è¡Œé€‚å½“çš„æ‰©å±•ï¼š

```python
# å‡†å¤‡æ‰©å±•æ“ä½œçš„è¾“å…¥
arg = is_mem_read.select(data, Bits(32)(0))

# è®¡ç®—ç¬¦å·æ‰©å±•çš„å¡«å……å€¼
sign = arg[7:7]  # å–å­—èŠ‚çš„æœ€é«˜ä½ï¼ˆç¬¦å·ä½ï¼‰
ext = sign.select(Bits(24)(0xffffff), Bits(24)(0))
#     â”‚               â”‚                    â”‚
#     â”‚ å¦‚æœç¬¦å·ä½=1  â”‚ å¡«å…… 0xffffff      â”‚ å¡«å…… 0x000000
#     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

# æ ¹æ® mem_ext é€‰æ‹©æ‰©å±•æ–¹å¼
data_cut = mem_ext[1:1].select(
    Bits(24)(0).concat(arg[0:7]),   # é›¶æ‰©å±•ï¼šé«˜ä½å¡« 0
    ext.concat(arg[0:7])             # ç¬¦å·æ‰©å±•ï¼šé«˜ä½å¡«ç¬¦å·ä½
)
```

**æ•°æ®æ‰©å±•ç¤ºä¾‹**ï¼š

| åŸå§‹å­—èŠ‚    | é›¶æ‰©å±• (lbu) | ç¬¦å·æ‰©å±• (lb) |
| ----------- | ------------ | ------------- |
| 0x7F (+127) | 0x0000007F   | 0x0000007F    |
| 0x80 (-128) | 0x00000080   | 0xFFFFFF80    |
| 0xFF (-1)   | 0x000000FF   | 0xFFFFFFFF    |

---

### ç¬¬å››æ­¥ï¼šé€‰æ‹©æœ€ç»ˆè¾“å‡ºæ•°æ®

```python
# å¦‚æœä¸æ˜¯å†…å­˜è¯»ï¼Œä½¿ç”¨æ‰§è¡Œé˜¶æ®µçš„ result
arg = is_mem_read.select(arg, result)

# å¦‚æœæ˜¯å­—èŠ‚è®¿é—®ï¼Œä½¿ç”¨æ‰©å±•åçš„æ•°æ®
arg = mem_ext[0:0].select(data_cut, arg)
```

**æ•°æ®é€‰æ‹©æµç¨‹å›¾**ï¼š

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚           æ•°æ®æ¥æºé€‰æ‹©               â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                         â”‚                         â”‚
            â–¼                         â–¼                         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  D-Cache æ•°æ®  â”‚         â”‚ D-Cache å­—èŠ‚  â”‚         â”‚ æ‰§è¡Œé˜¶æ®µç»“æœ  â”‚
    â”‚   (32-bit)    â”‚         â”‚  (æ‰©å±•å)     â”‚         â”‚   (result)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                         â”‚                         â”‚
            â”‚ is_mem_read &           â”‚ is_mem_read &           â”‚ ~is_mem_read
            â”‚ ~mem_ext[0]             â”‚ mem_ext[0]              â”‚
            â”‚                         â”‚                         â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚   æœ€ç»ˆ arg    â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### ç¬¬äº”æ­¥ï¼šè®¾ç½®å†™å›æ—è·¯

```python
wb_bypass_data[0] = arg
wb_bypass_reg[0] = rd
```

å†™å›æ—è·¯ï¼ˆWrite-Back Bypassï¼‰æä¾›äº†é¢å¤–ä¸€çº§çš„æ•°æ®å‰é€’æœºä¼šï¼Œç”¨äºå¤„ç†æ›´é•¿çš„ä¾èµ–é“¾ã€‚

---

### ç¬¬å…­æ­¥ï¼šè°ƒç”¨å†™å›æ¨¡å—

```python
wb_bound = writeback.bind(mdata=arg, rd=rd)
wb_bound.async_called()
```

**`bind()` å’Œ `async_called()` çš„ä½œç”¨**ï¼š

1. `bind()`: å°†å‚æ•°ç»‘å®šåˆ°ç›®æ ‡æ¨¡å—çš„ç«¯å£
2. `async_called()`: å¼‚æ­¥è°ƒç”¨ç›®æ ‡æ¨¡å—

è¿™ç§è®¾è®¡å…è®¸æµæ°´çº¿çš„å„é˜¶æ®µç‹¬ç«‹è¿è¡Œï¼Œé€šè¿‡ FIFO ç¼“å†²å®ç°æ¾è€¦åˆã€‚

---

## ğŸ“Š è®¿å­˜é˜¶æ®µä¸ D-Cache çš„äº¤äº’

### D-Cache ç»“æ„

D-Cache åœ¨æ‰§è¡Œé˜¶æ®µè¢«å®ä¾‹åŒ–å’Œè®¿é—®ï¼š

```python
# åœ¨ Execution ä¸­
dcache = SRAM(width=32, depth=1<<depth_log, init_file=data)
dcache.name = 'dcache'
dcache.build(we=memory_write, re=memory_read, wdata=b, addr=request_addr)
```

### è®¿é—®æ—¶åº

```
å‘¨æœŸ N (æ‰§è¡Œé˜¶æ®µ):
  - è®¡ç®—åœ°å€
  - å‘èµ· D-Cache è®¿é—®è¯·æ±‚
  - we=å†™ä½¿èƒ½, re=è¯»ä½¿èƒ½, addr=åœ°å€

å‘¨æœŸ N+1 (è®¿å­˜é˜¶æ®µ):
  - D-Cache è¿”å›æ•°æ® (rdata)
  - è¿›è¡Œæ•°æ®å¤„ç†å’Œæ—è·¯è®¾ç½®
```

### Store æŒ‡ä»¤å¤„ç†

Store æŒ‡ä»¤ï¼ˆå¦‚ `sw`ï¼‰åœ¨æ‰§è¡Œé˜¶æ®µå°±å®Œæˆäº†å†™å…¥ï¼š

```python
# åœ¨ Execution ä¸­
dcache.build(we=memory_write, re=memory_read, wdata=b, addr=request_addr)
#            â”‚                                  â”‚
#            â”‚ memory_write = signals.memory[1:1]
#            â”‚ å¦‚æœæ˜¯ storeï¼Œwe=1              â”‚
#            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
#                                              â”‚
#                        wdata = b (rs2 çš„å€¼) â”€â”˜
```

è®¿å­˜é˜¶æ®µå¯¹ store æŒ‡ä»¤çš„å¤„ç†å¾ˆç®€å•ï¼š

- `is_mem_read = 0`
- ä¸è®¾ç½®æ—è·¯ï¼ˆstore ä¸å†™å¯„å­˜å™¨ï¼‰
- ç›´æ¥ä¼ é€’ `result` ç»™å†™å›é˜¶æ®µ

---

## ğŸ” ä¸åŒæŒ‡ä»¤åœ¨è®¿å­˜é˜¶æ®µçš„è¡Œä¸º

### Load æŒ‡ä»¤ (lw, lbu)

| æ­¥éª¤ | æ“ä½œ                         |
| ---- | ---------------------------- |
| 1    | ä» `rdata` è·å– D-Cache æ•°æ® |
| 2    | æ ¹æ® `mem_ext` è¿›è¡Œæ‰©å±•      |
| 3    | è®¾ç½® `mem_bypass` æ—è·¯       |
| 4    | è°ƒç”¨å†™å›ï¼Œå†™å…¥ `rd`          |

### Store æŒ‡ä»¤ (sw, sb)

| æ­¥éª¤ | æ“ä½œ                              |
| ---- | --------------------------------- |
| 1    | `is_mem_read = 0`ï¼Œè·³è¿‡å¤§éƒ¨åˆ†å¤„ç† |
| 2    | ä¸è®¾ç½®æ—è·¯                        |
| 3    | è°ƒç”¨å†™å›ï¼ˆä½† `rd` é€šå¸¸ä¸º 0ï¼‰      |

### éè®¿å­˜æŒ‡ä»¤ (add, beq, etc.)

| æ­¥éª¤ | æ“ä½œ                              |
| ---- | --------------------------------- |
| 1    | `is_mem_read = 0`                 |
| 2    | ç›´æ¥ä½¿ç”¨ `result`ï¼ˆæ¥è‡ªæ‰§è¡Œé˜¶æ®µï¼‰ |
| 3    | è®¾ç½® `wb_bypass`                  |
| 4    | è°ƒç”¨å†™å›                          |

---

## ğŸ“ˆ æ—¶åºå›¾

```
ä¿¡å·            â”‚ å‘¨æœŸ N â”‚ å‘¨æœŸ N+1 â”‚ å‘¨æœŸ N+2 â”‚
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
lw æŒ‡ä»¤ä½ç½®     â”‚   E    â”‚    M     â”‚    W     â”‚
D-Cache è¯·æ±‚    â”‚   â–²    â”‚          â”‚          â”‚
D-Cache å“åº”    â”‚        â”‚    â–¼     â”‚          â”‚
mem_bypass æœ‰æ•ˆ â”‚        â”‚    â–ˆâ–ˆâ–ˆ   â”‚          â”‚
wb_bypass æœ‰æ•ˆ  â”‚        â”‚          â”‚    â–ˆâ–ˆâ–ˆ   â”‚
å¯„å­˜å™¨å†™å…¥      â”‚        â”‚          â”‚    â–²     â”‚
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ—è·¯æ•°æ®çš„ç”Ÿå‘½å‘¨æœŸ

```
mem_bypass_data æœ‰æ•ˆæœŸï¼š1 ä¸ªå‘¨æœŸ
       â”‚
       â”œâ”€ å‘¨æœŸ N: è®¿å­˜é˜¶æ®µè®¾ç½®
       â”‚
       â””â”€ å‘¨æœŸ N+1: æ‰§è¡Œé˜¶æ®µå¯ä½¿ç”¨
                     å‘¨æœŸ N+2: è¢«æ–°å€¼è¦†ç›–
```

### 2. x0 å¯„å­˜å™¨çš„ç‰¹æ®Šå¤„ç†

```python
with Condition(rd != Bits(5)(0)):
    mem_bypass_data[0] = data
```

x0 æ’ä¸º 0ï¼Œä¸éœ€è¦è®¾ç½®æ—è·¯ã€‚

### 3. éå¯¹é½è®¿é—®

å½“å‰å®ç°å‡è®¾æ‰€æœ‰è®¿é—®éƒ½æ˜¯å¯¹é½çš„ï¼š

- `lw`/`sw`: 4 å­—èŠ‚å¯¹é½
- `lb`/`sb`: ä»»æ„å¯¹é½

éå¯¹é½è®¿é—®éœ€è¦é¢å¤–ç¡¬ä»¶æ”¯æŒï¼ˆå½“å‰æœªå®ç°ï¼‰ã€‚

---

## ğŸ”— ä¸å…¶ä»–é˜¶æ®µçš„æ¥å£

### ä»æ‰§è¡Œé˜¶æ®µæ¥æ”¶

```python
# æ‰§è¡Œé˜¶æ®µå‘é€
bound = memory.bind(
    rd=rd,
    result=signals.link_pc.select(pc0, result),
    mem_ext=signals.mem_ext,
    is_mem_read=memory_read
)
bound.async_called()
```

### å‘é€åˆ°å†™å›é˜¶æ®µ

```python
# è®¿å­˜é˜¶æ®µå‘é€
wb_bound = writeback.bind(mdata=arg, rd=rd)
wb_bound.async_called()
```

---

## ğŸ“Š æ€§èƒ½ç‰¹æ€§

| æŒ‡æ ‡         | å€¼                   |
| ------------ | -------------------- |
| å»¶è¿Ÿ         | 1 å‘¨æœŸ               |
| ååé‡       | 1 æŒ‡ä»¤/å‘¨æœŸ          |
| æ—è·¯å»¶è¿Ÿ     | 0 å‘¨æœŸï¼ˆåŒå‘¨æœŸå¯ç”¨ï¼‰ |
| D-Cache è®¿é—® | å•å‘¨æœŸï¼ˆå‡è®¾å‘½ä¸­ï¼‰   |
